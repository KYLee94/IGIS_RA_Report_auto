# -*- coding: utf-8 -*-
"""IGIS_RA_ì£¼ê°„ì—…ë¬´ë³´ê³  ì—…ë°ì´íŠ¸ ìë™í™”

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1P5REaLeippt6jWf2BGcCk2w1Ui8si0g_
"""

# 1. ë…¸ì…˜ í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
!pip install notion-client

# 2. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
import os
from notion_client import Client

# 3. Notion API í‚¤ ë° ë°ì´í„°ë² ì´ìŠ¤ ID ì„¤ì •
# ---------------------------------------------------------------
# âš ï¸ ì¤‘ìš”: ì•„ë˜ ê°’ë“¤ì„ ìì‹ ì˜ ì •ë³´ë¡œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.
# ---------------------------------------------------------------

# GitHub Actionsì˜ Secretsì—ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
NOTION_API_KEY = os.environ.get('NOTION_API_KEY')
MASTER_DB_ID = os.environ.get('MASTER_DB_ID')
# ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ë³€í™˜
SOURCE_DB_IDS = os.environ.get('SOURCE_DB_IDS', '').split(',')

# 4. Notion í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
notion = Client(auth=NOTION_API_KEY)

# 5. í•µì‹¬ ë¡œì§: ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™” í•¨ìˆ˜
def sync_databases():
    print("ğŸš€ ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")

     # --- ë‹¨ê³„ 0: ë§ˆìŠ¤í„° DBì˜ ëª¨ë“  í•­ëª© ì‚­ì œ (ì´ˆê¸°í™”) ---
    print("\nğŸ—‘ï¸ ë§ˆìŠ¤í„° ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    try:
        # ë§ˆìŠ¤í„° DBì—ì„œ ì´ì „ì— ë™ê¸°í™”ëœ ëª¨ë“  í˜ì´ì§€ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
        master_pages_to_delete = notion.databases.query(
            database_id=MASTER_DB_ID,
            filter={"property": "Project_Title", "rich_text": {"is_not_empty": True}}
        ).get("results")

        # ê° í˜ì´ì§€ë¥¼ 'ë³´ê´€ ì²˜ë¦¬'í•˜ì—¬ ì‚­ì œí•©ë‹ˆë‹¤.
        for page in master_pages_to_delete:
            page_id = page["id"]
            notion.pages.update(page_id=page_id, archived=True)

        print(f"  âœ… {len(master_pages_to_delete)}ê°œì˜ ê¸°ì¡´ í•­ëª©ì„ ì‚­ì œ(ë³´ê´€)í–ˆìŠµë‹ˆë‹¤.")

    except Exception as e:
        print(f"âŒ ë§ˆìŠ¤í„° DB ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return # ì´ˆê¸°í™”ì— ì‹¤íŒ¨í•˜ë©´ ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•Šê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.

    # --- ë‹¨ê³„ 1: ë§ˆìŠ¤í„° DBì—ì„œ ì´ë¯¸ ë™ê¸°í™”ëœ í•­ëª© ID ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ---
    existing_source_ids = set()
    try:
        master_pages = notion.databases.query(database_id=MASTER_DB_ID).get("results")
        for page in master_pages:
            source_id_property = page.get("properties", {}).get("Source_ID", {})
            if source_id_property.get("rich_text"):
                existing_source_ids.add(source_id_property["rich_text"][0]["plain_text"])
        print(f"\nâœ… ë§ˆìŠ¤í„° DBì—ì„œ {len(existing_source_ids)}ê°œì˜ ê¸°ì¡´ í•­ëª©ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.")
    except Exception as e:
        print(f"âŒ ë§ˆìŠ¤í„° DB ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        return

    # --- ë‹¨ê³„ 2: ê° ì†ŒìŠ¤ DBë¥¼ ìˆœíšŒí•˜ë©° ë°ì´í„° ë™ê¸°í™” ---
    for db_id in SOURCE_DB_IDS:
        print(f"\nğŸ”„ ì†ŒìŠ¤ DB ({db_id[:6]}...) ì²˜ë¦¬ ì¤‘...")
        try:
            source_pages = notion.databases.query(database_id=db_id).get("results")
            print(f"  - {len(source_pages)}ê°œì˜ í•­ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.")

            for page in source_pages:
                page_id = page["id"]

                if page_id in existing_source_ids:
                    continue

                # --- ë‹¨ê³„ 3: ìƒˆ í•­ëª©ì„ ë§ˆìŠ¤í„° DBì— ìƒì„± (ì´ë¯¸ì§€ ê¸°ì¤€ ì†ì„± ë§¤í•‘) ---
                props = page.get("properties", {})

                # ê° ì†ì„± ê°’ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
                # âš ï¸ ì²« ë²ˆì§¸ 'ì œëª©' ì†ì„±ì˜ ì‹¤ì œ ì´ë¦„ì´ 'ì´ë¦„'ì´ ë§ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”!
                title_prop = props.get("Issue", {}).get("title", [])
                title_content = title_prop[0].get("text", {}).get("content", "ì œëª© ì—†ìŒ") if title_prop else "ì œëª© ì—†ìŒ"

                # ë‚˜ë¨¸ì§€ ì†ì„±ë“¤
                phase_prop = props.get("Phase", {}).get("select", [])
                title_prop = props.get("Project_Title",{}).get("rich_text", [])
                milestone_prop = props.get("Milestone", {}).get("multi_select", [])
                issue_type_prop = props.get("Issue_Type", {}).get("multi_select", [])
                firstwriter_prop = props.get("First_Writer", {}).get("rich_text", [])
                help_needed_prop = props.get("Help_Needed", {}).get("rich_text", [])
                issue_status_prop = props.get("Issue_Status", {}).get("select") # selectëŠ” ê¸°ë³¸ê°’ None
                severity_prop = props.get("Severity", {}).get("select")
                due_prop = props.get("Due", {}).get("date")
                eta_prop = props.get("ETA", {}).get("date")
                pm_check_prop = props.get("PM_Check", {}).get("checkbox", False)


                new_page_properties = {
                    "Issue": {"title": [{"text": {"content": title_content}}]},
                    "Project_Title": {"rich_text": title_prop},
                    "Phase": {"select": phase_prop},
                    "Milestone": {"multi_select": milestone_prop},
                    "Issue_Type": {"multi_select": issue_type_prop},
                    "First_Writer": {"rich_text": firstwriter_prop},
                    "Help_Needed": {"rich_text": help_needed_prop},
                    "Issue_Status": {"select": issue_status_prop},
                    "Severity": {"select": severity_prop},
                    "Due": {"date": due_prop},
                    "ETA": {"date": eta_prop},
                    "PM_Check": {"checkbox": pm_check_prop}
                    #"Source_ID": {"rich_text": [{"text": {"content": page_id}}]} # ì¤‘ë³µ ë°©ì§€ìš©
                }

                # ë¹ˆ ê°’(None)ì¸ ì†ì„±ì€ API ìš”ì²­ì—ì„œ ì œì™¸ (ì˜¤ë¥˜ ë°©ì§€)
                new_page_properties = {k: v for k, v in new_page_properties.items() if v.get(list(v.keys())[0]) is not None}


                notion.pages.create(
                    parent={"database_id": MASTER_DB_ID},
                    properties=new_page_properties
                )
                print(f"  â• ìƒˆ í•­ëª© ì¶”ê°€: {title_content}")

        except Exception as e:
            import traceback
            print(f"âŒ ì†ŒìŠ¤ DB ({db_id[:6]}...) ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            traceback.print_exc()

    print("\nğŸ‰ ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ë™ê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")

# 6. í•¨ìˆ˜ ì‹¤í–‰
sync_databases()

